{% extends "education/school_base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load static %}
{% load orders %}

{% block title %}
{% if object.pk and object.status != 'i' %}{% trans "Edit order" %} {{ object }}{% else %}{% trans "Create new order" %}{% endif %}
{% endblock %}

{% block breadcrumb %}{{ block.super }}
    {% comment %}<li><a href="{% url "education:candidates" uuid=school.uuid %}">{% trans "Candidates" %}</a></li>{% endcomment %}
    <li><a href="{% url "education:orders" uuid=school.uuid %}">{% trans "Orders" %}</a></li>
    <li>{% if object.pk and object.status != 'i' %}{% trans "Edit order" %} {{ object }}{% else %}{% trans "Create new order" %}{% endif %}</li>
{% endblock %}

{% block content %}
<h1>{% if object.pk and object.status != 'i' %}{% trans "Edit order" %} {{ object.date }}{% else %}{% trans "Create new order" %}{% endif %} <small>{{ school.name }}</small></h1>
{% blocktrans %}Using this form you can order examination materials for your school.{% endblocktrans %}

<form method="post" action="{% url "education:orderedit" uuid=school.uuid order_uuid=object.uuid %}">
    
    {{ form|crispy }}
    {% for i in inlines %}
    <fieldset>
        <legend>{% trans "Tests and CDs to be ordered" %}</legend>
        {% crispy i helper %}
    </fieldset>
    {% endfor %}
    {{ inlines.management_form|crispy }}

<!-- TODO -->
{% with object.get_items as order_items %}
{% regroup order_items by subject.group as groups %}
{% for group in groups %}
<h4>{{ group.grouper.name }}</h4>
<table class="table table-striped">
    <thead>
        <tr>
            <th></th>
            <th colspan="3" width="30%">{% trans "Amount (pcs)" %}</th>
        </tr>
        <tr>
            <th>{% trans "Subject" %}</th>
            {% for m in materials %}
            <th>{{ m }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tfoot>
        <tr>
            <th>{% trans "Total" %}</th>
            {% for m in materials %}
                <th>{% order_sg_total order group.grouper m %}</th>
            {% endfor %}
        </tr>
    </tfoot>
    <tbody>
        {% with group.list as item_list %}
        {% regroup item_list by subject as subjects %}
        {% for s in subjects %}
        <tr>
            <td>{{ s.grouper }}</td>
            {% for m in materials %}
                {% if s.grouper|subject_has_material:m %}
                <td style="width: 10%;"><input type="number" min="0" size="4" value="{% order_subject_count object s.grouper m %}"/></td>
                {% else %}
                <td>-</td>
                {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
        {% endwith %}
    </tbody>
</table>
{% endfor %}

<h4>{% trans "Additional Details" %}</h4>
<p>{{ object.additional_details|default:"(None)" }}</p>
{% endwith %}
<!-- TODO -->



    <p><strong>{% blocktrans %}Note: Order will replace previous orders for selected site when submitted.{% endblocktrans %}</strong></p>

    <p><input type="submit" value="{% trans "Submit" %}" class="btn btn-success"/> <input type="reset" value="{% trans "Reset" %}" class="btn btn-danger"/></p>

</form>
{% endblock %}

{% block extrascripts %}
{{ block.super }}
<script src="{% static "js/forms.js" %}"></script>
{% endblock %}

{% block extendstyle %}
{{ block.super }}
<style>
form table input.checkboxinput, form table th.checkbox {display: none;}
</style>
{% comment %}TODO: Fix...{% endcomment %}
{% endblock %}